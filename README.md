# redis-migrate-tool
一、功能介绍

迁移工具可实现下列功能：

1、读取信息文本生成迁移配置文件

2、启动迁移进程

3、提取迁移日志，生成概要信息

4、进行源端与目的端数据校验，生成校验日志

5、源端与目的端key数量获取

6、停止迁移进程

7、删除迁移配置文件

8、退出

1、读取信息文本生成迁移配置文件

按照指定格式将迁移数据源和目的端相关信息填写至info.txt文件后，按数字1执行配置文件生成。
完成后会提示用户对相关路径下的文件内容进行复核。

2、启动迁移进程

完成配置文件生成后，按数字2启动迁移进程。如当前系统中已有迁移进程，则无法启动，会输出报错提示。
启动后会检测所有进程是否均已启动并反馈结果。如有进程未启动，会提示用户进行检查。

3、提取迁移日志，生成概要信息

迁移进程启动后，按数字3提取日志目录下的日志文件，返回数据同步状态，是否有IO报错和是否有失去连接报错。
数据同步状态会输出已完成数据同步的进程数量和未完成数据同步的日志文件名称。如所有进程数据同步进程均已完成，
会输出全部完成。IO报错和失去连接报错正常状态下无输出，如有进程报错，会输出对应日志文件名称。用户可以到相应
路径下查看日志。

4、进行源端与目的端数据校验，生成校验日志

按数字4可进行源端与目的端数据校验，启动校验前会提示用户再次确认源端连接的是否是从库，输入指定确认字符后方可继续。
否则退回至主菜单。用户可自行设置校验key数量占key总量的比例，用于控制校验数据量。校验完成后会输出提示和校验
日志文件名称。

5、源端与目的端key数量获取

按数字5可输出源端与目的端key数量信息，供用户进行比对。

6、停止迁移进程

按数字6可停止当前系统所有迁移进程。操作前会输出提示要求用户再次确认，输入指定确认字符后方可继续。否则退回至主菜单。
每个进程结束都会输出OK字符。如有进程未结束，会输出提示要求用户手动检查并结束进程。

7、删除迁移配置文件

按数字7可删除所有迁移配置文件，防止误操作启动迁移工具导致目的端数据被源端数据覆盖。删除前会对系统中的迁移进程
进行检测，如有迁移进程运行则无法删除配置文件。

8、退出

按数字8可退出迁移工具。已启动的迁移进程不受影响。

迁移操作步骤

1、修改迁移数据信息文件info.txt

   JDCAUTH：下另起一行，填写公有云redis实例登录密码
   JIMDBAUTH:下另起一行，填写JIMDB redis实例登录密码，如无登录密码，该行置空，不要编辑。
   JDCURL:下另起一行，填写公有云redis实例连接域名
   JIMDBURL:下另起一行，填写需要迁移的JIMDB redis源分片信息。每行填写一个分片信息，格式为IP地址:端口号然后另起   一行填写下一个分片信息
   修改完成后保存文件,从windows导入的文本信息文件，需要在linux中使用vi编辑器执行set fileformat=unix后保存文件
   
2、检查info.txt中所有信息是否正确

3、清空conf_password和conf_check目录下的所有文件

4、清空log目录下的所有文件

5、执行redis-mig-tool.sh启动迁移工具

6、按数字1执行gen.sh脚本生成迁移使用的所有配置文件
   gen.sh脚本实际调用了三个子脚本gen_cfg.sh、gen_mig.sh和gen_chk.sh。
   gen_cfg.sh脚本修改迁移数据源列表文件hosts.txt、迁移数据配置文件rmt_password.conf和获取源数据key数量脚本sourceDbSize.sh
   gen_mig.sh为每个JIMDB分片生成迁移配置文件，
   gen_chk.sh为每个JIMDB分片生成校验配置文件。

7、检查hosts.txt文件内容是否正确

8、进入conf_password目录检查生成的配置文件是否正确

9、进入conf_check目录检查生成的配置文件是否正确

10、检查sourceDbSize.sh脚本中PASSWORD是否被替换为jimdb密码。

11、连接公有云实例，执行info命令，查看是否有残留key，执行flushall命令清空所有残留key。同时需要确认是否有客户端对公有云实例进行读写。

12、在迁移工具界面按数字2执行start.sh脚本开始迁移

13、执行ps -ef|grep redis-migrate-tool查看迁移工具进程，有几个分片就应该看到几个进程

14、在迁移工具界面按数字3执行log_check.sh脚本检查日志中迁移完成情况和是否有报错

15、在迁移工具界面按数字5执行脚本key_num.sh获取源数据key数量和公有云redis实例key数量，查看两端是否一致

16、数据校验：

    a.在工具界面按数字4执行key_check.sh脚本自动校验（无从库的jimdb实例严禁使用该校验方式），需要设置校验key数量占总key数量的除比，如设置为10，则校验Key数量为总量的十分之一。
     （校验量视迁移key总量而定，一般抽查上限为十分之一左右即可，无需全部校验，遇有key数量较大的实例校验比例需要进一步降低）校验结果见
      checksum.out和log/check*。如校验结果提示有instant expire key（橙色字体），是源端和目的端key的过期值不一致导致，可以忽略。如提示instant values key（红色字体），则源端和
      目的端存在key值不一致的key。可能为源端应用没有停止写，导致源端key值更新，而源端和目的端数据同步存在延迟导致。如数量不多，可暂时忽略，待源端应用停止写后再次进行校验。
      
    b.使用工具手动校验（无从库的jimdb实例严禁使用该校验方式）：
      执行./redis-migrate-tool -c conf_check/rmt_*.conf -o log/check -C "redis_check 200000"
      逐一对每个jimdb分片的key和公有云实例的key做校验。
      该工具只能在jimdb从库上使用，绝不能在主库上使用。且key值不能过大，强烈建议正式迁移前先做测试，没有问题后再在正式迁移中使用校验工具
    
    c.分别连接JIMDB执行scan 0 MATCH *，任选几个key，执行get key与公有云实例同名key做value值比对

17、再次按数字3检查log目录下的所有日志，确认没有报错。通知到家人员停止JIMDB读写，持续观察JIMDB的key数量与公有云key数量是否一致，
    一致后再按步骤16的方法做一次数据校验，确认没有问题

18、在迁移工具界面按数字6执行stop_test.sh结束迁移进程后切换应用至公有云实例

19、在迁移工具界面按数字7清空conf_password、conf_check目录，hosts.txt、rmt_password.conf、rmt_check.conf中的所有JIMDB和公有云信息

备注：

1、在迁移过程中需要持续关注迁移工具状态
   redis-cli -p 1500x info stats

2、建议在正式迁移前留出足够时间做迁移测试和校验测试。如果特殊情况下对jimdb主分片进行迁移操作，不可轻易做迁移测试和校验测试。
